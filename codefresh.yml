version: '1.0'

steps:
  build_backend:
    title: Building backend image
    type: build
    image_name: wslaghekke/releases-app
    working_directory: ${{main_clone}}
    dockerfile: Dockerfile
  build_static:
    title: Building client js
    image: node
    commands:
      - cd client
      - npm install
      - npm run build
      - cd ..
  build_frontend:
    title: Building frontend image
    type: build
    image_name: wslaghekke/releases-nginx
    working_directory: ${{main_clone}}
    dockerfile: docker/nginx/Dockerfile
  launch_composition:
    title: Launching releases
    type: launch-composition
    environment_name: releases-ci
    entry_point: nginx
    composition:
      version: '3'
      services:
        nginx:
          image: ${{build_frontend}}
          ports:
            - '80'
          depends_on:
            - app
        app:
          image: ${{build_frontend}}
          environment:
            - DB_HOST=releases
            - DB_PORT=3306
            - DB_NAME=releases
            - DB_USER=releases
            - DB_PASSWORD=password
            - DB_RANDOM_ROOT_PASSWORD=true
          depends_on:
            - mysql
        mysql:
          image: mysql
          environment:
            - MYSQL_DATABASE=releases
            - MYSQL_PASSWORD=password
            - MYSQL_RANDOM_ROOT_PASSWORD=true
            - MYSQL_USER=releases